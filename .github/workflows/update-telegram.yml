name: Update Telegram Data & Posts
on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Configure Git and reset to latest
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions Bot"
          git fetch origin main
          git reset --hard origin/main
          
      - name: Install RSS parser
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet curl
          
      - name: Get Telegram subscriber count
        run: |
          # –ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–Ω–∞–ª–∞
          curl -s -A "Mozilla/5.0" "https://t.me/s/analinhistory" -o telegram.html
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
          SUBSCRIBERS=$(grep -oP '\d+(?:,\d+)*(?=\s*subscribers?)' telegram.html | head -1)
          
          if [ -z "$SUBSCRIBERS" ]; then
            SUBSCRIBERS="950+"
          fi
          
          echo "üìä –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: $SUBSCRIBERS"
          echo "SUBSCRIBERS=$SUBSCRIBERS" >> $GITHUB_ENV
          
      - name: Get latest posts from RSS
        run: |
          # –ü–æ–ª—É—á–∞–µ–º RSS –ª–µ–Ω—Ç—É –∫–∞–Ω–∞–ª–∞
          curl -s "https://rsshub.app/telegram/channel/analinhistory" -o rss.xml
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ RSS
          if [ ! -s rss.xml ] || ! xmlstarlet val rss.xml 2>/dev/null; then
            echo "‚ö†Ô∏è RSS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback"
            cat > docs/posts-data.json << 'EOF'
[
  {
    "title": "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ö—Ä–æ–Ω–∏–∫–∏ –∫–∞–Ω–∞–ª–∞",
    "date": "22.07.2025",
    "content": "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –≤ –Ω–∞—à–µ–º Telegram –∫–∞–Ω–∞–ª–µ @analinhistory"
  }
]
EOF
          else
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –ø–æ—Å—Ç–∞
            xmlstarlet sel -t \
              -m "//item[position()<=2]" \
              -v "concat('{\"title\":\"', title, '\",\"date\":\"', substring(pubDate,1,16), '\",\"content\":\"', substring(description,1,200), '...\"},')" \
              rss.xml > posts_raw.txt
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º JSON –º–∞—Å—Å–∏–≤ –ø–æ—Å—Ç–æ–≤
            echo "[" > docs/posts-data.json
            sed '$ s/,$//' posts_raw.txt >> docs/posts-data.json
            echo "]" >> docs/posts-data.json
          fi
          
      - name: Create combined data file
        run: |
          mkdir -p docs
          
          # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π JSON —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ –∏ –ø–æ—Å—Ç–∞–º–∏
          cat > docs/telegram-data.json << EOF
{
  "subscribers": "$SUBSCRIBERS",
  "updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "channel": "@analinhistory",
  "posts": $(cat docs/posts-data.json 2>/dev/null || echo '[]')
}
EOF
          
      - name: Commit and push all updates
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --exit-code docs/ > /dev/null 2>&1; then
            echo "üìä –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å"
            exit 0
          fi
          
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –ø–æ—Å—Ç—ã"
          
          git add docs/
          git commit -m "üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ: $SUBSCRIBERS –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ + –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã ($(date '+%d.%m %H:%M'))"
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
          git push origin main --force-with-lease || git push origin main --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
